<!DOCTYPE html><html lang="ru" prefix="og: http://ogp.me/ns# ya: http://webmaster.yandex.ru/vocabularies/config article: http://ogp.me/ns/article#"><head><meta charset="utf-8"><meta name="author" content="Роман Татауров"><title>Пробую NRF51822</title><meta name="description" content="Как настроить рабочее окружение для разработки софта под BLE модули на чипе nRF51822 и запустить на нём первую тестовую программу."><meta name="keywords" content="Bluetooth,JLink,BLE,nRF51822"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta property="og:title" content=""><meta property="og:site_name" content="DiyTronic"><meta property="og:locale" content="ru_RU"><meta property="og:url" content="https://diytronic.ru/2017/12/05/testing-nrf51822-ble-module/"><meta property="og:type" content="article"><meta property="og:description"><meta property="article:tag" content="[&quot;Bluetooth&quot;,&quot;JLink&quot;,&quot;BLE&quot;,&quot;nRF51822&quot;]"><meta property="article:section" content="[&quot;Электроника&quot;]"><meta property="article:published_time" content="2017-12-05T18:49:24.000Z"><meta property="article:modified_time" content="2017-12-05T18:49:24.000Z"><meta name="DC.Title" content="Пробую NRF51822"><meta name="DC.Subject"><meta name="DC.Creator" content="Роман Татауров"><meta name="DC.Creator.Name" content="Роман Татауров"><meta name="DC.Date" scheme="WTN8601" content="2017-12-05T18:49:24.000Z"><meta name="DC.Type" content="Text"><meta name="DC.Language" content="ru-RU"><meta name="apple-mobile-web-app-title" content="WebHive"><meta name="application-name" content="WebHive"><meta name="msapplication-TileColor" content="#2b5797"><meta name="theme-color" content="#ffffff"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link type="text/css" rel="stylesheet" href="/css/app-66a13052.css"><link rel="alternate" href="/atom.xml" title="DiyTronic | Заметки об электронике, программировании, 3D-печати" type="application/atom+xml"><meta name="generator" content="Hexo 5.4.2"></head><body class="page" itemscope itemtype="http://schema.org/WebPage" itemid="https://diytronic.ru/2017/12/05/testing-nrf51822-ble-module/"><section class="header"> <div class="header__content"><div class="content-wrapper content-wrapper_header"><div class="title-box"><button class="button button_header button_left js-main-nav"><span class="icon"><svg width="24" height="24" viewBox="0 0 1000 1000"><path d="M108,206h784c54.1,0,98-43.9,98-98c0-54.1-43.9-98-98-98H108c-54.1,0-98,43.9-98,98C10,162.1,53.9,206,108,206z M892,402H108c-54.1,0-98,43.9-98,98c0,54.1,43.9,98,98,98h784c54.1,0,98-43.9,98-98C990,445.9,946.1,402,892,402z M892,794H108c-54.1,0-98,43.9-98,98c0,54.1,43.9,98,98,98h784c54.1,0,98-43.9,98-98C990,837.9,946.1,794,892,794z"></path></svg></span></button><a href="/"><img class="title-box__logo logo logo--main" src="/images/logo.png"/></a><h1 class="title-box__title"><a href="/">DiyTronic</a></h1><div class="title-box__description"><a href="/">Заметки об электронике, программировании, 3D-печати</a></div><button class="button button_header button_right js-search"><span class="icon"><svg width="24" height="24" viewBox="0 0 1000 1000"><path d="M688.5,424.6c0-72.6-25.8-134.8-77.4-186.4s-113.8-77.4-186.4-77.4s-134.8,25.8-186.4,77.4S160.8,352,160.8,424.6c0,72.6,25.8,134.8,77.4,186.4c51.6,51.6,113.8,77.4,186.4,77.4S559.4,662.6,611,611C662.6,559.4,688.5,497.3,688.5,424.6L688.5,424.6z M990,914.6c0,20.4-7.5,38.1-22.4,53c-14.9,14.9-32.6,22.4-53,22.4c-21.2,0-38.9-7.5-53-22.4l-202-201.4c-70.3,48.7-148.6,73-235,73c-56.1,0-109.8-10.9-161.1-32.7s-95.4-51.2-132.5-88.3c-37.1-37.1-66.5-81.3-88.3-132.5C20.9,534.5,10,480.8,10,424.6s10.9-109.8,32.7-161.1S93.9,168.1,131,131c37.1-37.1,81.3-66.6,132.5-88.3S368.5,10,424.6,10s109.8,10.9,161.1,32.7c51.2,21.8,95.4,51.2,132.5,88.3c37.1,37.1,66.6,81.3,88.3,132.5c21.8,51.2,32.7,104.9,32.7,161.1c0,86.4-24.3,164.7-73,235l202,202C982.7,876.1,990,893.8,990,914.6L990,914.6z"></path></svg></span></button></div><nav class="main-nav" itemscope itemtype="http://schema.org/SiteNavigationElement"><ul class="main-menu-bar"><li class="main-menu-bar__item"><a class="main-menu-bar__item-link" itemprop="url" href="/">Главная</a></li><li class="main-menu-bar__item"><a class="main-menu-bar__item-link" itemprop="url" href="/categories/uncategorized/">Разное</a></li><li class="main-menu-bar__item"><a class="main-menu-bar__item-link" itemprop="url" href="/categories/3d-print/">3D Печать</a></li><li class="main-menu-bar__item"><a class="main-menu-bar__item-link" itemprop="url" href="/categories/programming/">Программирование</a></li><li class="main-menu-bar__item"><a class="main-menu-bar__item-link" itemprop="url" href="/categories/electronics/">Электроника</a></li><li class="main-menu-bar__item"><a class="main-menu-bar__item-link" itemprop="url" href="/categories/repair/">Ремонт</a></li><li class="main-menu-bar__item"><a class="main-menu-bar__item-link js-#{i}" itemprop="url" href="/archives">Архив</a></li><li class="main-menu-bar__item"><a class="main-menu-bar__item-link js-#{i}" itemprop="url" href="/search">Поиск</a></li></ul></nav><script>var yandexSearchOptions = {
  action: '/search/',
  arrow: false,
  bg: 'transparent',
  fontsize: 16,
  fg: '#FFF',
  language: 'ru',
  logo: 'rb',
  publicname: 'Поиск по сайту www.diytronic.ru',
  suggest: false,
  target: '_self',
  tld: 'ru',
  type: 2,
  searchid: 2298791,
  webopt: false,
  websearch: false,
  input_fg: '#FFF',
  input_bg: 'transparent',
  input_fontStyle: 'normal',
  input_fontWeight: 'normal',
  input_placeholder: 'Поиск по сайту',
  input_placeholderColor: '#FFF',
  input_borderColor: 'transparent'
}
</script><div class="content-wrapper__search-box"><button class="button button_type_close button__control js-close-search"><span class="icon"><svg width="32" height="32" viewBox="0 0 348.333 348.334"><path d="M336.559,68.611L231.016,174.165l105.543,105.549c15.699,15.705,15.699,41.145,0,56.85   c-7.844,7.844-18.128,11.769-28.407,11.769c-10.296,0-20.581-3.919-28.419-11.769L174.167,231.003L68.609,336.563   c-7.843,7.844-18.128,11.769-28.416,11.769c-10.285,0-20.563-3.919-28.413-11.769c-15.699-15.698-15.699-41.139,0-56.85   l105.54-105.549L11.774,68.611c-15.699-15.699-15.699-41.145,0-56.844c15.696-15.687,41.127-15.687,56.829,0l105.563,105.554   L279.721,11.767c15.705-15.687,41.139-15.687,56.832,0C352.258,27.466,352.258,52.912,336.559,68.611z"></path></svg></span></button><div class="ya-site-form ya-site-form_inited_no" onclick="return yandexSearchOptions"><form class="search" action="https://yandex.ru/sitesearch" method="get" target="_self"><input type="hidden" name="searchid" value="2298791"/><input type="hidden" name="l10n" value="ru"/><input type="hidden" name="reqenc" value=""/><span class="input input_search"><span class="input__box"><input class="input__control" placeholder="Поиск" name="text"></span></span><button class="button button_type_submit button_search button__control" type="submit"><span class="icon"><svg width="24" height="24" viewBox="0 0 512 512"><path d="M445,386.7l-84.8-85.9c13.8-24.1,21-50.9,21-77.9c0-87.6-71.2-158.9-158.6-158.9C135.2,64,64,135.3,64,222.9c0,87.6,71.2,158.9,158.6,158.9c27.9,0,55.5-7.7,80.1-22.4l84.4,85.6c1.9,1.9,4.6,3.1,7.3,3.1c2.7,0,5.4-1.1,7.3-3.1l43.3-43.8C449,397.1,449,390.7,445,386.7z M222.6,125.9c53.4,0,96.8,43.5,96.8,97c0,53.5-43.4,97-96.8,97c-53.4,0-96.8-43.5-96.8-97C125.8,169.4,169.2,125.9,222.6,125.9z"></path></svg></span></button></form></div></div><footer class="copyright copyright--sidebar">&copy; 2023 DiyTronic</footer></div></div><div class="header__overlay"></div></section><div class="content-wrapper content-wrapper_main"><main class="content content_main" itemprop="mainEntityOfPage"> <article class="post post--full" itemscope itemtype="http://schema.org/Article" itemprop="mainEntityOfPage">
  <header>
    <h2 class="post__title" itemprop="headline">
      <a class="link link__control link_post-title" href="/2017/12/05/testing-nrf51822-ble-module/">
        Пробую NRF51822
      </a>
    </h2>
    <div class="post__meta">
      <time class="post__date" datetime="2017-12-05T18:49:24.000Z" itemprop="datePublished">
        5 декабря 2017
      </time>
      <span class="post__author" itemscope itemtype="http://schema.org/Person" itemprop="author"> Автор: <span itemprop="name">Роман Татауров</span></span>
      <meta itemscope itescope itemType="https://schema.org/Person" itemprop="publisher" content="Роман Татауров" />
      <a class="link link__control link_comments-count" href="https://diytronic.ru/2017/12/05/testing-nrf51822-ble-module/#disqus_thread"></a>
    </div>
  </header>

  <div class="post__entry" itemprop="articleBody">
    
    <p>Есть у&nbsp;меня китайский <a target="_blank" rel="noopener" href="http://ali.pub/2617ov">BLE модуль на&nbsp;nRF51822</a>. Давно собирался с&nbsp;ним поэкспериментировать и&nbsp;вот руки наконец дошли. К&nbsp;сожалению информации о&nbsp;работе с&nbsp;этими модулями не&nbsp;так много, поэтому решил поделиться своим опытом.</p>
<span id="more"></span>

<h1 id="Железо"><a href="#Железо" class="headerlink" title="Железо"></a>Железо</h1><h2 id="Модуль-nRF51822"><a href="#Модуль-nRF51822" class="headerlink" title="Модуль nRF51822"></a>Модуль nRF51822</h2><img src="/2017/12/05/testing-nrf51822-ble-module/nrf51822-module.jpg" class="" title="Фото nRF51822 модуля">

<p>Собственно модуль представляет собой распаянный на&nbsp;плату чип nRF51822 с&nbsp;всей необходимой обвязкой и&nbsp;пинами выведенными на&nbsp;пару гребёнок. Ну&nbsp;и&nbsp;как любой микроконтроллер он&nbsp;может быть прошит неким кодом, который может управлять портами ввода/вывода. Ну&nbsp;и&nbsp;главным бонусом идёт встроенный Bluetooth LE&nbsp;модуль.</p>
<p>Хочу особо обратить внимание на&nbsp;тот факт, что существует несколько вариаций чипа с&nbsp;разными вариантам памяти. Это будет важно в&nbsp;дальнейшем. Поэтому советую посмотреть прямо на&nbsp;чипе маркировку.</p>
<img src="/2017/12/05/testing-nrf51822-ble-module/nrf51-chip-markings.png" class="" title="Маркировка чипа nRF51822">

<p>Естественным желанием было воткнуть модуль в&nbsp;брэдборд и&nbsp;потестировать. Но&nbsp;не&nbsp;ту-то было. Модуль имеет 4&nbsp;ряда выводов, что как&nbsp;бы&nbsp;уже обламывает всю идею, но&nbsp;к&nbsp;тому-же оказалось выводы имеют нестандартный шаг 2&nbsp;мм, так что даже на&nbsp;макетку его не&nbsp;воткнуть. В&nbsp;поисках какого-нибудь переходника наткнулся на&nbsp;готовую отладочную плату для таки модулей <a target="_blank" rel="noopener" href="http://ali.pub/25xm36">BLE400</a>.</p>
<h2 id="Плата-BLE400"><a href="#Плата-BLE400" class="headerlink" title="Плата BLE400"></a>Плата BLE400</h2><img src="/2017/12/05/testing-nrf51822-ble-module/ble400-board.jpg" class="" title="Фото платы BLE400">

<p>Вариант с&nbsp;платой выглядел поинтереснее, поэтому данная плата немедленно <a target="_blank" rel="noopener" href="http://ali.pub/25xm36">была закуплена у&nbsp;китайских коммерсантов</a>. Собственно эта плата представляет собой разъём для модуля, пины, выведенные на&nbsp;штырьки, некоторые пины выведены на&nbsp;светодиоды (через перемычки), 2&nbsp;пина подключены к&nbsp;кнопкам (опять&nbsp;же&nbsp;через перемычки). Так-же есть несколько стандартных разъёмов опять&nbsp;же&nbsp;подключенных к&nbsp;пинам модуля и&nbsp;USB -&gt; COM преобразователь, который позволяет во&nbsp;первых запитать модуль через&nbsp;USB, а&nbsp;во&nbsp;вторых позволяет использовать UART прямо через&nbsp;USB. В&nbsp;общем простая, но&nbsp;полезная штука.</p>
<p>Итак плата BLE400 в&nbsp;наличии, модуль воткнут в&nbsp;разъём.</p>
<p>Втыкаем плату и&nbsp;видим в&nbsp;логах, что она определилась как /dev/ttyUSB0</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg</span><br><span class="line">...</span><br><span class="line">[35577.734982] usbcore: registered new interface driver usbserial</span><br><span class="line">[35577.734992] usbcore: registered new interface driver usbserial_generic</span><br><span class="line">[35577.734999] usbserial: USB Serial support registered <span class="keyword">for</span> generic</span><br><span class="line">[35577.738586] usbcore: registered new interface driver cp210x</span><br><span class="line">[35577.738596] usbserial: USB Serial support registered <span class="keyword">for</span> cp210x</span><br><span class="line">[35577.738619] cp210x 3-1:1.0: cp210x converter detected</span><br><span class="line">[35577.740213] usb 3-1: cp210x converter now attached to ttyUSB0</span><br></pre></td></tr></table></figure>

<p>Надо для неё проделать старый хитрый трюк с&nbsp;udev, чтобы получить стабильное неизменное&nbsp;имя. Ну&nbsp;что&nbsp;&mdash; поехали. Находим соответствующee USB устройство.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lsusb</span><br><span class="line">...</span><br><span class="line">Bus 003 Device 071: ID 10c4:ea60 Cygnal Integrated Products, Inc. CP2102/CP2109 UART Bridge Controller [CP210x family]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Смотрим udev аттрибуты</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ udevadm info --attribute-walk -n /dev/ttyUSB0</span><br><span class="line">...</span><br><span class="line">    ATTRS&#123;idProduct&#125;==<span class="string">&quot;ea60&quot;</span></span><br><span class="line">    ATTRS&#123;idVendor&#125;==<span class="string">&quot;10c4&quot;</span></span><br><span class="line">    ...</span><br><span class="line">    ATTRS&#123;serial&#125;==<span class="string">&quot;0001&quot;</span></span><br></pre></td></tr></table></figure>

<p>И прописываем его в&nbsp;правило udev</p>
<figure class="highlight plaintext"><figcaption><span>/etc/udev/rules.d/99-ble400.rules</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SUBSYSTEM==&quot;tty&quot;, ATTRS&#123;idVendor&#125;==&quot;10c4&quot;, ATTRS&#123;idProduct&#125;==&quot;ea60&quot;, ATTRS&#123;serial&#125;==&quot;0001&quot; GROUP=&quot;users&quot;, MODE=&quot;0666&quot;, SYMLINK+=&quot;ble400&quot;</span><br></pre></td></tr></table></figure>

<p>Теперь перезагружаем правила</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo udevadm control --reload-rules</span><br></pre></td></tr></table></figure>

<p>И отсоединяем/подсоединяем кабель устройства и&nbsp;наблюдаем в&nbsp;папке /dev/ устройство ble400&nbsp;которое является фактически ссылкой на&nbsp;реальный файл устройства. Ну,&nbsp;а&nbsp;нам того и&nbsp;надо.</p>
<h1 id="Подключение-и-прошивка"><a href="#Подключение-и-прошивка" class="headerlink" title="Подключение и прошивка"></a>Подключение и&nbsp;прошивка</h1><p>В сети нашёл несколько вариантов общения с&nbsp;модулем. Как правило по&nbsp;умолчанию модуль должен иметь встроенный UART, что теоретически должно дать нам возможность как минимум проверить подаёт&nbsp;ли&nbsp;модуль какие-то признаки жизни.</p>
<h2 id="USB-serial"><a href="#USB-serial" class="headerlink" title="USB serial"></a>USB serial</h2><p>Итак втыкаем плату с&nbsp;модулем в&nbsp;USB разъём и&nbsp;пробуем подключиться к&nbsp;UART-у. В&nbsp;ответ на&nbsp;посылку ему команду &laquo;y&raquo; от&nbsp;должен ответить &laquo;Start &hellip;&raquo;.</p>
<p>Не прокатило&nbsp;&mdash; не&nbsp;отзывается на&nbsp;команды вообще никак. Только загорается светодиод&nbsp;SPD. При отправке команды &laquo;y&raquo; моргает&nbsp;Rx.&nbsp;Возможно просто в&nbsp;чипе хрен знает какая прошивка или он&nbsp;вообще девственно чист. Т.е. вроде как соединения устанавливается, но&nbsp;ни&nbsp;на&nbsp;какие команды не&nbsp;реагирует. Возможно (и скорей всего)  нужно просто подобрать правильную скорость соединения.</p>
<p>Ну как говорится&nbsp;&mdash; &laquo;не очень-то и&nbsp;хотелось&raquo;. Будем пробовать дальше. Вопрос с&nbsp;работоспособностью по&nbsp;прежнему остаётся открытым.</p>
<h2 id="Bluetooth"><a href="#Bluetooth" class="headerlink" title="Bluetooth"></a>Bluetooth</h2><p>Попытка номер&nbsp;два. Предположил, что при подключении у&nbsp;нас должно быть видно какое-то Bluetooth устройство. Втыкаем опять плату с&nbsp;модулем в&nbsp;USB, чтоб подать питание. Для тестирования использовал смартфон Xiaomi mi4c, который имеет поддержку&nbsp;BLE. Для тестирования использовал софт от&nbsp;нордиков&nbsp;&mdash; <a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=no.nordicsemi.android.nrftoolbox&hl=ru">nRF Toolbox</a> и&nbsp;<a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=no.nordicsemi.android.mcp&hl=ru">nRF Connect</a>. Но&nbsp;всё тщетно&nbsp;&mdash; никаких признаков неизвестных BLE устройств обнаружено не&nbsp;было. Это как-то уже начинает напрягать.</p>
<h2 id="Bus-Pirate"><a href="#Bus-Pirate" class="headerlink" title="Bus Pirate"></a>Bus Pirate</h2><p>Вот тут <a target="_blank" rel="noopener" href="http://floe.butterbrot.org/matrix/hacking/nrf/">http://floe.butterbrot.org/matrix/hacking/nrf/</a> какие-то ребята экспериментируют с&nbsp;подключением через Bus Pirate. Попробовал данный вариант&nbsp;&mdash; к&nbsp;плате могу подконнектиться, прочитать память, записать туда что-то. Но&nbsp;возможности крайне скудные. Там какой-то самописный программатор собранный на&nbsp;коленке под конкретный девайс. Заглянул в&nbsp;код и&nbsp;закрыл от&nbsp;греха подальше. Всё, что можно узнать о&nbsp;подключенном устройстве это первые 1000&nbsp;байт из&nbsp;памяти. Ну&nbsp;и&nbsp;записать в&nbsp;устройство можно все что угодно начиная с&nbsp;заданного адреса.</p>
<p>Однако это уже первый позитивный опыт&nbsp;&mdash; по&nbsp;крайней мере устройство отзывалось и&nbsp;давало записать в&nbsp;себя файлы прошивок. В&nbsp;остальном&nbsp;&mdash; никакого толку.</p>
<h2 id="J-link"><a href="#J-link" class="headerlink" title="J-link"></a>J-link</h2><p>Ну что&nbsp;&mdash; пришлось расчехлить старый добрый J-Link, который уже давно пылился на&nbsp;полке. К&nbsp;этому моменту я&nbsp;уже изрядно <del>подзае</del> наковырялся с&nbsp;SDK и&nbsp;даже читал стандартную документацию из&nbsp;комплекта, поэтому в&nbsp;теме уже немножко шарил. Оказывается J-Link это как раз и&nbsp;есть самый прямой путь к&nbsp;счастью. Да&nbsp;и&nbsp;на&nbsp;плате BLE400&nbsp;есть готовый разъём, поэтому она немедленно была вкорячена в&nbsp;J-Link-овский шлейфик и&nbsp;<strong>внимание!</strong> это важно подключена через USB к&nbsp;компьютеру. Как оказалось J-Link напрочь отказывается питать подключенное устройство.</p>
<p>В итоге получаем что-то эдакое:</p>
<img src="/2017/12/05/testing-nrf51822-ble-module/ble400-and-jlink.jpg" class="" title="Подключение BLE400 к JLink">

<p><strong>Важно!!!</strong></p>
<p>Владельцев китайских J-Link-ов предупреждаю&nbsp;&mdash; не&nbsp;пользоваться стандартной программой для прошивки из&nbsp;SDK <code>nrfjprog</code>. Она использует родную библиотеку от&nbsp;SEGGER, которая палит, что устройство является китайским клоном и&nbsp;убивает его (по счастью не&nbsp;намертво). Я&nbsp;на&nbsp;эти грабли наступил, но&nbsp;косяк этот для меня не&nbsp;в&nbsp;диковинку, поэтому быстро всё восстановил. Ну,&nbsp;а&nbsp;остальные&nbsp;&mdash; на&nbsp;свой риск и&nbsp;страх&nbsp;&mdash; я&nbsp;вас предупредил.</p>
<p>Собственно именно по&nbsp;этой причине на&nbsp;фото J-Link в&nbsp;разобранном состоянии&nbsp;&mdash; пришлось его заново перешивать, что невозможно без разбора.</p>
<p>Итак берём рабочий софт от&nbsp;J-Link и&nbsp;пробуем подключится J-Link Commander-ом. Собственно в&nbsp;командной строке указываем имя устройства (я был реально удивлён, что J-Link &laquo;знает&raquo; о&nbsp;nRF51822), скорость и&nbsp;тип подключения (swd) </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ JLinkExe -device nrf51822 -speed 1000 -<span class="keyword">if</span> swd</span><br><span class="line">SEGGER J-Link Commander V4.84f (<span class="string">&#x27;?&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>)</span><br><span class="line">Compiled May  9 2014 20:12:27</span><br><span class="line">Info: Device <span class="string">&quot;NRF51822_XXAA&quot;</span> selected (257 KB flash, 16 KB RAM).</span><br><span class="line">DLL version V4.84f, compiled May  9 2014 20:12:24</span><br><span class="line">Firmware: J-Link ARM V8 compiled Jul 17 2014 12:31:18</span><br><span class="line">Hardware: V8.00</span><br><span class="line">S/N: 158005115</span><br><span class="line">Feature(s): RDI,FlashDL,FlashBP,JFlash,GDBFull</span><br><span class="line">VTarget = 3.332V</span><br><span class="line">Info: Found SWD-DP with ID 0x0BB11477</span><br><span class="line">Info: Found Cortex-M0 r0p0, Little endian.</span><br><span class="line">Info: FPUnit: 4 code (BP) slots and 0 literal slots</span><br><span class="line">Found 1 JTAG device, Total IRLen = 4:</span><br><span class="line">Cortex-M0 identified.</span><br><span class="line">Target interface speed: 1000 kHz</span><br><span class="line">J-Link&gt;</span><br></pre></td></tr></table></figure>

<p>Как мы&nbsp;видим произошло успешное подключение и&nbsp;даже определился тип чипа <code>Device &quot;NRF51822_XXAA&quot;</code>, память <code>(257 KB flash, 16 KB RAM)</code> и&nbsp;процессор <code>Found Cortex-M0 r0p0</code>, что как&nbsp;бы&nbsp;намекает&nbsp;нам, что ура&nbsp;&mdash; всё работает.<br>Итак модуль подключен и&nbsp;подаёт признаки жизни&nbsp;&mdash; теперь осталось попробовать залить туда какой-то код и&nbsp;убедиться, что он&nbsp;заработает ну&nbsp;и&nbsp;что вообще мы&nbsp;можем в&nbsp;дальнейшем писать под него&nbsp;код.</p>
<p>Ну и&nbsp;остаётся нераскрыта тема SWD программаторов, коих у&nbsp;китайцев несть числа. Теоретически они должны работать, т.&nbsp;к.&nbsp;это урезанные JLink-и работающие только через&nbsp;SWD. Но&nbsp;у&nbsp;меня такого под рукой&nbsp;нет, поэтому сказать ничего не&nbsp;могу.</p>
<h1 id="Софт"><a href="#Софт" class="headerlink" title="Софт"></a>Софт</h1><p>С софтом дело оказалось очень даже неплохо, хотя и&nbsp;немного запутано. Итак компания Nordic поставляет полный набор софта для разработки, кучу примеров и&nbsp;документации.</p>
<p>Качаем SDK с&nbsp;сайта <a target="_blank" rel="noopener" href="https://developer.nordicsemi.com/nRF51_SDK/">https://developer.nordicsemi.com/nRF51_SDK/</a></p>
<p>Казалось&nbsp;бы&nbsp;вполне логично взять распоследнюю версию&nbsp;SDK. На&nbsp;сегодняшний день (январь 2018)  это v14. Но&nbsp;не&nbsp;тут-то было. В&nbsp;принципе оно как&nbsp;бы&nbsp;должно работать, но&nbsp;SDK версии 14&nbsp;полностью ориентирован на&nbsp;чипы серии nRF52 и&nbsp;все примеры по&nbsp;умолчанию используют библиотеки именно для этих чипов.</p>
<p>Я конечно вызов принял и&nbsp;было даже попробовал заменить ссылки на&nbsp;библиотеки для nRF51,&nbsp;но&nbsp;не&nbsp;особо преуспел в&nbsp;этом. Код успешно собирается, но&nbsp;залитый в&nbsp;устройство не&nbsp;работает. Пока притормозил эту тему&nbsp;&mdash; думаю можно заставить его работать, но&nbsp;я&nbsp;пока решил взять SDK более старой версии, а&nbsp;именно v10. Просто наугад: )  Ну&nbsp;и&nbsp;обнаружил, что там как раз всё вертится вокруг nRF51&nbsp;семейства, что мне и&nbsp;нужно.</p>
<p>Итого для чипов семейства nRF51&nbsp;стоит начать обучение с&nbsp;SDK v10. Просто будет чуть проще начать.</p>
<p>Итак качаем и&nbsp;распаковываем <a target="_blank" rel="noopener" href="https://developer.nordicsemi.com/nRF51_SDK/nRF51_SDK_v10.x.x/nRF51_SDK_10.0.0_dc26b5e.zip">nRF51_SDK_10.0.0</a></p>
<h2 id="Немного-теории"><a href="#Немного-теории" class="headerlink" title="Немного теории"></a>Немного теории</h2><p>Как уже писал выше чип nRF51822&nbsp;это в&nbsp;общем-то обычный микроконтроллер. Поэтому мы&nbsp;можем просто написать для него&nbsp;код, залить в&nbsp;устройство и&nbsp;наслаждаться работой. Проблема тут одна&nbsp;&mdash; Bluetooth. При таком подходе нужно будет написать свой Bluetooth стэк, что хоть и&nbsp;в&nbsp;принципе возможно, но&nbsp;крайне трудно осуществимо иначе мне лишь останется позавидовать вашим способностям и&nbsp;крайне удивится зачем вы&nbsp;это читаете.</p>
<p>В принципе можно использовать этот чип не&nbsp;задействовав Bluetooth&nbsp;&mdash; просто как микроконтроллер. Но&nbsp;зачем, Ватсон?! Ну&nbsp;в&nbsp;общем это очевидный бред и&nbsp;нелепость.</p>
<p>Простым&nbsp;же&nbsp;смертным людям, которым от&nbsp;этого модуля нужен всё-таки Bluetooth нужен какой-то способ этот Bluetooth использовать прямо здесь и&nbsp;сейчас. И&nbsp;вот для этого случая компания Nordic поставляет некоторый&nbsp;код, называемый softdevice. Фактически это некая мини операционная система которая прошивается в&nbsp;устройство, а&nbsp;свой код мы&nbsp;пишем уже используя API этого softdevice-а.</p>
<h2 id="Softdevice"><a href="#Softdevice" class="headerlink" title="Softdevice"></a>Softdevice</h2><p>Именно поэтому в&nbsp;примерах SDK как правило есть примеры в&nbsp;подпапке <code>blank</code>&nbsp;т.&nbsp;е.&nbsp;запускаемые на&nbsp;голом контроллере и&nbsp;примеры для конкретных версий softdevice-ов (с префиксом &laquo;s&raquo;). Как я&nbsp;понял softdevice-ы отличаются набором функций и&nbsp;размещением в&nbsp;памяти. Конкретно для nRF51822&nbsp;есть sofdevice-ы версий <code>s110</code>, <code>s120</code> и&nbsp;<code>s130</code>. Sofdevice-ы поставляются в&nbsp;виде закрытого кода и&nbsp;исходники их&nbsp;недоступны.</p>
<p>Вот по&nbsp;этой ссылке <a target="_blank" rel="noopener" href="https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF51822">https://www.nordicsemi.com/eng/Products/Bluetooth-low-energy/nRF51822</a> в&nbsp;разделе &laquo;Downloads&raquo; можно скачать softdevice-ы для nRF51822. Я&nbsp;не&nbsp;стал мудрить&nbsp;&mdash; выкачал последний. Внутри просто hex файл прошивки. Кстати чуть позже нашёл в&nbsp;SDK папку <code>softdevice</code> где лежат те-же файлы.</p>
<p>Ну и&nbsp;чтоб не&nbsp;откладывать дела в&nbsp;долгий ящик зальём что-ли softdevice в&nbsp;наше устройство. Запускаем JLink, цепляем к&nbsp;нему ble400 c&nbsp;модулем и&nbsp;не&nbsp;забываем ble400&nbsp;подключить к&nbsp;источнику питания (просто воткнем в&nbsp;USB компьютера). Ниже привожу последовательность команд JLink для заливки softdevice-а:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">J-Link&gt;r</span><br><span class="line">Reset delay: 0 ms</span><br><span class="line">Reset <span class="built_in">type</span> NORMAL: Resets core &amp; peripherals via SYSRESETREQ &amp; VECTRESET bit.</span><br><span class="line">J-Link&gt;w4 4001e504 2</span><br><span class="line">Writing 00000002 -&gt; 4001E504</span><br><span class="line">J-Link&gt;w4 4001e50c 1</span><br><span class="line">Writing 00000001 -&gt; 4001E50C</span><br><span class="line">J-Link&gt;w4 4001e514 1</span><br><span class="line">Writing 00000001 -&gt; 4001E514</span><br><span class="line">J-Link&gt;w4 4001e504 0</span><br><span class="line">Writing 00000000 -&gt; 4001E504</span><br><span class="line">J-Link&gt;r</span><br><span class="line">Reset delay: 0 ms</span><br><span class="line">Reset <span class="built_in">type</span> NORMAL: Resets core &amp; peripherals via SYSRESETREQ &amp; VECTRESET bit.</span><br><span class="line">J-Link&gt;loadfile /home/roman/.Projects/nrf51/softdevice/s130_nrf51_2.0.1_softdevice.hex</span><br><span class="line">Info: J-Link: Flash download: Flash programming performed <span class="keyword">for</span> 2 ranges (108544 bytes)</span><br><span class="line">Info: J-Link: Flash download: Total time needed: 2.012s (Prepare: 0.126s, Compare: 0.041s, Erase: 0.000s, Program: 1.827s, Verify: 0.010s, Restore: 0.007s)</span><br><span class="line">J-Link&gt;r</span><br><span class="line">Reset delay: 0 ms</span><br><span class="line">Reset <span class="built_in">type</span> NORMAL: Resets core &amp; peripherals via SYSRESETREQ &amp; VECTRESET bit.</span><br></pre></td></tr></table></figure>

<p>Команды типа <code>w4</code> это запись 4-х байтового значения по&nbsp;заданному адресу. Конкретно эти я&nbsp;нашёл где-то в&nbsp;сети. Не&nbsp;очень чётко понимаю что там делается. Заявлено было, что это стирание каких-то областей. В&nbsp;общем надо будет подразобраться с&nbsp;этим шаманством. Но&nbsp;тем не&nbsp;менее это работает. Как видно из&nbsp;команды <code>loadfile</code> заливаю туда прямо hex файл.</p>
<p>Подсмотрел <a target="_blank" rel="noopener" href="https://diyiot.wordpress.com/2015/11/29/ble-application-with-nrf51822-firmware-flashing/">тут</a></p>
<p>На этом считаю заливку softdevice-а законченной. Теперь нам нужно сварить и&nbsp;залить в&nbsp;модуль какой-нибудь интересный&nbsp;код, чтоб убедиться, что мы&nbsp;можем таки им&nbsp;управлять. По&nbsp;традиции это будет мигающий светодиод&nbsp;&mdash; благо их&nbsp;на&nbsp;плате аж&nbsp;5&nbsp;штук и&nbsp;ничего дополнительно делать не&nbsp;надо. Но&nbsp;для начала некоторые нюансы&nbsp;SDK.</p>
<h2 id="BLE400-и-SDK"><a href="#BLE400-и-SDK" class="headerlink" title="BLE400 и SDK"></a>BLE400 и&nbsp;SDK</h2><p>Как оказалось все примеры рассчитаны на&nbsp;стандартные платы от&nbsp;Nordic. Но&nbsp;в&nbsp;то-же время нордики благородно оставили возможность <a target="_blank" rel="noopener" href="http://infocenter.nordicsemi.com/index.jsp?topic=/com.nordic.infocenter.sdk51.v10.0.0/index.html">добавить свою плату</a>. Фактически нужно создать файл где нужно пробить соответствия физических пинов устройства внутренним константам&nbsp;SDK.</p>
<p>С другой стороны все эти платы в&nbsp;SDK не&nbsp;более чем некие наборы констант (тупо сишные define-ы)  и&nbsp;можно вполне обойтись без всего этого геморроя с&nbsp;поддержкой плат. Тем не&nbsp;менее раз уж&nbsp;разобрался&nbsp;&mdash; поделюсь опытом.</p>
<p>Для SDK v10&nbsp;все определения плат лежат в&nbsp;папке <code>examples/bsp</code>. Создаём там файл платы <a target="_blank" rel="noopener" href="https://gist.github.com/webhive/55a453d2bd319ba7aa5541fceae7e71a">custom_board.h</a>. И&nbsp;в&nbsp;дальнейшем будем использовать именно&nbsp;его.</p>
<h2 id="Запускаем-тестовый-пример"><a href="#Запускаем-тестовый-пример" class="headerlink" title="Запускаем тестовый пример"></a>Запускаем тестовый пример</h2><p>Как уже писал выше для теста будем использовать простейший пример&nbsp;&mdash; моргающие светодиоды. Такой пример есть&nbsp;SDK. расположен он&nbsp;в&nbsp;папке <code>examples/peripheral/blinky</code>. Как мы&nbsp;видим в&nbsp;ней есть как уже скомпилированные варианты прошивок под различные платы, так и&nbsp;исходники под конкретные платы. Нашей платы BLE400&nbsp;там очевидно&nbsp;нет, поэтому просто скопируем какую-нибудь из&nbsp;существующих и&nbsp;потом подправим её&nbsp;под свои нужды:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cp</span> -R pca10028 ble400</span><br></pre></td></tr></table></figure>
<p>Вот так вот незатейливо. Внутри у&nbsp;нас 2&nbsp;папки <code>blink</code> и&nbsp;<code>s110</code>. Первая нам не&nbsp;нужна и&nbsp;её&nbsp;можно смело удалить, а&nbsp;вторая это как раз вариант под softdevice. В&nbsp;данном случае под <code>s110</code>, хотя мы&nbsp;только что залили в&nbsp;модуль <code>s130</code>, но&nbsp;для такого примитивного примера это не&nbsp;беда.</p>
<p>Итак входим в&nbsp;папку s110. Внутри подпапки для различных компиляторов. Нас интересует armgcc. Ура&nbsp;&mdash; мы&nbsp;наконец видим Makefile и&nbsp;какой-то ld&nbsp;файл. Ну&nbsp;и&nbsp;к&nbsp;слову исходный код лежит в&nbsp;<code>examples/peripheral/blinky</code>&nbsp;&mdash; это файл <code>main.c</code>. Собственно эти 3&nbsp;файла нам и&nbsp;нужны.</p>
<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><p>Итак для начала правим Makefile. Заменяем везде <code>CFLAGS  = -DBOARD_PCA10028</code> на&nbsp;<code>CFLAGS  = -DBOARD_CUSTOM</code>. Так-же меняем<br>везде по&nbsp;тексту <code>xxac</code> на&nbsp;<code>xxaa</code>. Причина смотри выше про типы чипов. Пример сделан под другой тип чипа. Ну&nbsp;и&nbsp;нужно заменить имя softdevice-а&nbsp;&mdash; S110&nbsp;на&nbsp;S130.</p>
<p>Я ещё поменял <code>PROJECT_NAME</code> на&nbsp;<code>PROJECT_NAME := blinky_s110_ble400</code>.</p>
<h3 id="ld-файл"><a href="#ld-файл" class="headerlink" title="ld файл"></a>ld файл</h3><p>Далее нам надо подправить ld&nbsp;файл <code>blinky_gcc_nrf51.ld</code>&nbsp;&mdash; в&nbsp;этом файле описаны области памяти устройства и&nbsp;по&nbsp;умолчанию там данные для <code>xxac</code> чипов, а&nbsp;у&nbsp;нас <code>xxaa</code>. Поэтому нужно его поправить. Чтобы найти правильные значения для нашего чипа посмотрим папку <code>components/softdevice/s130/toolchain/armgcc</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -l components/toolchain/gcc</span><br><span class="line">...</span><br><span class="line">-rw-r--r-- 1 roman roman 391 ноя  9  2015 armgcc_s130_nrf51422_xxaa.ld</span><br><span class="line">-rw-r--r-- 1 roman roman 391 ноя  9  2015 armgcc_s130_nrf51422_xxac.ld</span><br><span class="line">-rw-r--r-- 1 roman roman 391 ноя  9  2015 armgcc_s130_nrf51822_xxaa.ld</span><br><span class="line">-rw-r--r-- 1 roman roman 390 ноя  9  2015 armgcc_s130_nrf51822_xxab.ld</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Вот они родимые. Смотрим что там у&nbsp;нас для <code>xxaa</code>.</p>
<p>Нас в&nbsp;этом файле интересует блок <code>MEMORY</code>&nbsp;&mdash; берём значения для полей <code>ORIGIN</code> и&nbsp;переносим в&nbsp;наш файл <code>blinky_gcc_nrf51.ld</code>. Далее нам надо посчитать значения полей <code>LENGTH</code>. Для FLASH это будет размер флеш-памяти устройства (для xxaa 256k)  минус размер, который занимает softdevice (для S130&nbsp;это 112k). Для MEM соответственно LENGTH будет равен размеру ОЗУ (16k для xxaa)  минус размер ОЗУ зарезервированный softdevice-ом (для S130&nbsp;&mdash; 10k).</p>
<p>Итого получаем следующий блок MEMORY, который мы&nbsp;и&nbsp;запишем в&nbsp;ld&nbsp;файл.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MEMORY</span><br><span class="line">&#123;</span><br><span class="line">  FLASH (rx) : ORIGIN = 0x1c000, LENGTH = 256k - 112k</span><br><span class="line">  RAM (rwx) :  ORIGIN = 0x20002800, LENGTH = 16k - 10k</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>На этом с&nbsp;ld&nbsp;файлом мы&nbsp;закончили.</p>
<h3 id="Компиляция"><a href="#Компиляция" class="headerlink" title="Компиляция"></a>Компиляция</h3><p>Да&nbsp;&mdash; совсем забыл&nbsp;&mdash; для сборки все этой истории в&nbsp;системе должны быть установлен компилятор для ARM процессоров. Это пакет <code>gcc-arm-none-eabi</code>. Для успешной сборки нам надо прописать путь к&nbsp;бинарнику компилятора в&nbsp;<code>components/toolchain/gcc/Makefile.posix</code>. Там по&nbsp;умолчанию какой-то хитрый путь, но&nbsp;в&nbsp;моём случае этот файл сейчас выглядит вот так</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GNU_INSTALL_ROOT := /usr/</span><br><span class="line">GNU_VERSION := 4.9.3</span><br><span class="line">GNU_PREFIX := arm-none-eabi</span><br></pre></td></tr></table></figure>

<p>Ну собственно вроде&nbsp;всё. Теперь возвращаемся в&nbsp;папку с&nbsp;Makefile-ом нашего тестового проекта с&nbsp;мигающим светодиодом. Ну&nbsp;и&nbsp;собственно&nbsp;т.&nbsp;к.&nbsp;у&nbsp;нас всё уже готово просто запускаем сборку.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line"><span class="built_in">rm</span> -rf _build</span><br><span class="line"><span class="built_in">echo</span>  Makefile</span><br><span class="line">Makefile</span><br><span class="line"><span class="built_in">mkdir</span> _build</span><br><span class="line">Compiling file: system_nrf51.c</span><br><span class="line">Compiling file: main.c</span><br><span class="line">Compiling file: nrf_delay.c</span><br><span class="line">Compiling file: gcc_startup_nrf51.s</span><br><span class="line">Linking target: nrf51422_xxaa_s110.out</span><br><span class="line">make[1]: вход в каталог «/home/roman/.Projects/nrf51/nRF51_SDK_10.0.0_dc26b5e/examples/peripheral/blinky/ble400/s110/armgcc»</span><br><span class="line">Preparing: nrf51422_xxaa_s110.bin</span><br><span class="line">Preparing: nrf51422_xxaa_s110.hex</span><br><span class="line"></span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">   1432	    104	    172	   1708	    6ac	_build/nrf51422_xxaa_s110.out</span><br><span class="line"></span><br><span class="line">make[1]: выход из каталога «/home/roman/.Projects/nrf51/nRF51_SDK_10.0.0_dc26b5e/examples/peripheral/blinky/ble400/s110/armgcc</span><br></pre></td></tr></table></figure>

<p>Как видим всё прошло успешно, правда в&nbsp;выводе мелькает nrf51422 (где-то я&nbsp;не&nbsp;немножко недопилил), но&nbsp;пока оставим это в&nbsp;покое. В&nbsp;данном случае на&nbsp;работу это не&nbsp;повлияет, хотя конечно надо будет разобраться.</p>
<p>Теперь у&nbsp;нас должна появиться папка <code>_build</code> в&nbsp;которой будет готовый hex файл прошивки.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -l _build</span><br><span class="line">-rw-r--r-- 1 roman roman   7300 янв  7 13:23 gcc_startup_nrf51.o</span><br><span class="line">-rw-r--r-- 1 roman roman   1136 янв  7 13:23 main.o</span><br><span class="line">-rwxr-xr-x 1 roman roman   1536 янв  7 13:23 nrf51422_xxaa_s110.bin</span><br><span class="line">-rw-r--r-- 1 roman roman   4367 янв  7 13:23 nrf51422_xxaa_s110.hex    &lt;- вот он</span><br><span class="line">-rw-r--r-- 1 roman roman  26325 янв  7 13:23 nrf51422_xxaa_s110.map</span><br><span class="line">-rwxr-xr-x 1 roman roman 140640 янв  7 13:23 nrf51422_xxaa_s110.out</span><br><span class="line">-rw-r--r-- 1 roman roman    888 янв  7 13:23 nrf_delay.o</span><br><span class="line">-rw-r--r-- 1 roman roman   1328 янв  7 13:23 system_nrf51.o</span><br></pre></td></tr></table></figure>

<h3 id="Заливаем-прошивку-в-устройство"><a href="#Заливаем-прошивку-в-устройство" class="headerlink" title="Заливаем прошивку в устройство"></a>Заливаем прошивку в&nbsp;устройство</h3><p>Запускаем JLink и&nbsp;BLE400&nbsp;так-же как мы&nbsp;это делали в&nbsp;случае с&nbsp;прошивкой softdevice. Не&nbsp;забываем подавать питание на&nbsp;BLE400! Ну&nbsp;и&nbsp;выполняем следующий набор команд: <code>loadfile</code>, <code>r</code>, <code>g</code>&nbsp;&mdash; смотри ниже.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ JLinkExe -device nrf51822 -speed 1000 -<span class="keyword">if</span> swd</span><br><span class="line">SEGGER J-Link Commander V4.84f (<span class="string">&#x27;?&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>)</span><br><span class="line">Compiled May  9 2014 20:12:27</span><br><span class="line">Info: Device <span class="string">&quot;NRF51822_XXAA&quot;</span> selected (257 KB flash, 16 KB RAM).</span><br><span class="line">DLL version V4.84f, compiled May  9 2014 20:12:24</span><br><span class="line">Firmware: J-Link ARM V8 compiled Jul 17 2014 12:31:18</span><br><span class="line">Hardware: V8.00</span><br><span class="line">S/N: 158005115</span><br><span class="line">Feature(s): RDI,FlashDL,FlashBP,JFlash,GDBFull</span><br><span class="line">VTarget = 3.332V</span><br><span class="line">Info: Found SWD-DP with ID 0x0BB11477</span><br><span class="line">Info: Found Cortex-M0 r0p0, Little endian.</span><br><span class="line">Info: FPUnit: 4 code (BP) slots and 0 literal slots</span><br><span class="line">Found 1 JTAG device, Total IRLen = 4:</span><br><span class="line">Cortex-M0 identified.</span><br><span class="line">Target interface speed: 1000 kHz</span><br><span class="line">J-Link&gt;loadfile ./_build/nrf51422_xxaa_s110.hex</span><br><span class="line">Info: J-Link: Flash download: Flash programming performed <span class="keyword">for</span> 1 range (2048 bytes)</span><br><span class="line">Info: J-Link: Flash download: Total time needed: 0.182s (Prepare: 0.090s, Compare: 0.002s, Erase: 0.043s, Program: 0.036s, Verify: 0.000s, Restore: 0.007s)</span><br><span class="line">J-Link&gt;r</span><br><span class="line">Reset delay: 0 ms</span><br><span class="line">Reset <span class="built_in">type</span> NORMAL: Resets core &amp; peripherals via SYSRESETREQ &amp; VECTRESET bit.</span><br><span class="line">J-Link&gt;g</span><br></pre></td></tr></table></figure>

<p>После этого наблюдаем плату с&nbsp;мигающими светодиодами.</p>
<div class="video-container"><iframe src="https://www.youtube.com/embed/34fL2iGT_bc" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

<p>В итоге всё получилось. Модуль рабочий и&nbsp;его можно успешно прошивать. Теперь осталось проверить остальные возможности и&nbsp;в&nbsp;особенности самую мякотку&nbsp;&mdash;&nbsp;BLE. Но&nbsp;это уже тема для отдельной статьи. Ну&nbsp;и&nbsp;нужно ещё подчистить Makefile, автоматизировать загрузку прошивки&nbsp;&mdash; в&nbsp;общем причесать весь процесс, чтобы не&nbsp;отвлекаться на&nbsp;рутину.</p>
<h1 id="Продолжение"><a href="#Продолжение" class="headerlink" title="Продолжение"></a>Продолжение</h1><ul>
<li><a href="/2018/01/08/nrf51822-trying-to-make-bluetooth-working/" title="Пробуем запустить Bluetooth">Пробуем запустить Bluetooth</a>

</li>
</ul>
<h1 id="Источники"><a href="#Источники" class="headerlink" title="Источники"></a>Источники</h1><ul>
<li><a target="_blank" rel="noopener" href="https://devzone.nordicsemi.com/question/70314/program-bluetooth-for-nrf51822-yunjia-board-with-stlink-v2/">https://devzone.nordicsemi.com/question/70314/program-bluetooth-for-nrf51822-yunjia-board-with-stlink-v2/</a></li>
<li><a target="_blank" rel="noopener" href="https://devzone.nordicsemi.com/blogs/22/getting-started-with-nrf51-development-on-mac-os-x/">https://devzone.nordicsemi.com/blogs/22/getting-started-with-nrf51-development-on-mac-os-x/</a></li>
<li><a target="_blank" rel="noopener" href="https://leavesified.wordpress.com/2016/03/24/setup-nrf51-development-on-linux/">https://leavesified.wordpress.com/24.03.2016/setup-nrf51-development-on-linux/</a></li>
<li><a target="_blank" rel="noopener" href="http://floe.butterbrot.org/matrix/hacking/nrf/">http://floe.butterbrot.org/matrix/hacking/nrf/</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.nordicsemi.com/nRF5_SDK/nRF51_SDK_v8.x.x/doc/8.0.0/s110/html/a00067.html">https://developer.nordicsemi.com/nRF5_SDK/nRF51_SDK_v8.x.x/doc/8.0.0/s110/html/a00067.html</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/bertrandmartel/a38315c5fe79ec5c8c6a9ed90b8df260">https://gist.github.com/bertrandmartel/a38315c5fe79ec5c8c6a9ed90b8df260</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@robertmassaioli/using-the-ble400-and-nrf51822-on-osx-a57ed723510d">https://medium.com/@robertmassaioli/using-the-ble400-and-nrf51822-on-osx-a57ed723510d</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@robertmassaioli/picking-the-right-nrf5-chip-for-you-8e334493a185">https://medium.com/@robertmassaioli/picking-the-right-nrf5-chip-for-you-8e334493a185</a></li>
<li><a target="_blank" rel="noopener" href="https://www.waveshare.com/wiki/NRF51822_Eval_Kit">https://www.waveshare.com/wiki/NRF51822_Eval_Kit</a></li>
<li><a target="_blank" rel="noopener" href="https://www.waveshare.com/nrf51822-eval-kit.htm">https://www.waveshare.com/nrf51822-eval-kit.htm</a></li>
<li><a target="_blank" rel="noopener" href="https://www.funwithelectronics.com/?id=168">https://www.funwithelectronics.com/? id=168</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sandeepmistry/arduino-nRF5#flashing-a-softdevice">https://github.com/sandeepmistry/arduino-nRF5#flashing-a-softdevice</a></li>
<li><a target="_blank" rel="noopener" href="http://redbearlab.com/nrf51822-sdk/">http://redbearlab.com/nrf51822-sdk/</a></li>
<li><a target="_blank" rel="noopener" href="https://gustavovelascoh.wordpress.com/2017/01/23/starting-development-with-nordic-nrf5x-and-gcc-on-linux/">https://gustavovelascoh.wordpress.com/23.01.2017/starting-development-with-nordic-nrf5x-and-gcc-on-linux/</a></li>
<li><a target="_blank" rel="noopener" href="https://leavesified.wordpress.com/2016/03/24/setup-nrf51-development-on-linux/">https://leavesified.wordpress.com/24.03.2016/setup-nrf51-development-on-linux/</a></li>
<li><a target="_blank" rel="noopener" href="http://infocenter.nordicsemi.com/index.jsp?topic=/com.nordic.infocenter.softdevices51/dita/nrf51/softdevices.html">http://infocenter.nordicsemi.com/index.jsp? topic=%2Fcom.nordic.infocenter.softdevices51%2Fdita%2Fnrf51%2Fsoftdevices.html</a></li>
<li><a target="_blank" rel="noopener" href="https://diyiot.wordpress.com/2015/11/29/ble-application-with-nrf51822-firmware-flashing/">https://diyiot.wordpress.com/29.11.2015/ble-application-with-nrf51822-firmware-flashing/</a></li>
</ul>
  </div>

  <footer>
      <ul class="tags tags_post">
      <li class="tags__label"><i class="icon-tags"></i></li>
            <li class="tags__tag">
          <span class="tag" itemprop="articleSection">
            <a class="link link__control link_tag" tabindex="0" href="/tags/bluetooth/">Bluetooth</a>
          </span>
        </li>
            <li class="tags__tag">
          <span class="tag" itemprop="articleSection">
            <a class="link link__control link_tag" tabindex="1" href="/tags/jlink/">JLink</a>
          </span>
        </li>
            <li class="tags__tag">
          <span class="tag" itemprop="articleSection">
            <a class="link link__control link_tag" tabindex="2" href="/tags/ble/">BLE</a>
          </span>
        </li>
            <li class="tags__tag">
          <span class="tag" itemprop="articleSection">
            <a class="link link__control link_tag" tabindex="3" href="/tags/nrf51822/">nRF51822</a>
          </span>
        </li>
          </ul>
  
  
    <ul class="categories categories_post">
      <li class="categories__label"><i class="icon-folder-empty"></i></li>
      
        <li class="categories__category">
          <span class="category" itemprop="articleSection">
            <a class="link link__control link_category" tabindex="0" href="/categories/electronics/">Электроника</a>
          </span>
        </li>
      
    </ul>
  
  <div class="share" style="margin: 1rem 0; display: flex; flex-direction: row; font-size: 90%">
  <div class="share__label" style="margin-right: 0.5rem">Поделиться:</div>
  <div class="share__body ya-share2" data-services="vkontakte,lj" data-size="s" data-description="Как настроить рабочее окружение для разработки софта под BLE модули на чипе nRF51822 и запустить на нём первую тестовую программу."></div>
</div>
  </footer>
</article>


<section class="comments">
  <h3 class="comments__title">Комментарии</h3>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



<footer class="copyright copyright--bottom">&copy; 2023 DiyTronic</footer>
</main></div><script>var disqus_config = function() {
  this.page.url = 'https://diytronic.ru/2017/12/05/testing-nrf51822-ble-module/';
  this.page.identifier = 'https://diytronic.ru/2017/12/05/testing-nrf51822-ble-module/';
};

(function() {  // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://diytronic.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();</script><noscript> <p class="disqus__no-js">Please enable JavaScript to view the <a target="_blank" href="https://disqus.com/?ref_noscript" rel="nofollow noopener">comments powered by Disqus.</a></p></noscript><!-- Yandex.Metrika counter--><script>(function (d, w, c) {
    (w[c] = w[c] || []).push(function() {
        try {
          w.yaCounter33124378 = new Ya.Metrika({
            id: '33124378',
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true,
            trackHash:true
          });
        } catch(e) { }
    });

    var n = d.getElementsByTagName("script")[0],
        s = d.createElement("script"),
        f = function () { n.parentNode.insertBefore(s, n); };
    s.type = "text/javascript";
    s.async = true;
    s.src = "https://mc.yandex.ru/metrika/watch.js";

    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else { f(); }
})(document, window, "yandex.metrika_callbacks");</script><noscript><div><img src="https://mc.yandex.ru/watch/#{config.yandex.metrika}" style="position:absolute; left:-9999px;" alt=""></div></noscript><!-- /Yandex.Metrika counter--><script src="https://yastatic.net/share2/share.js" async="async"></script><script src="/js/app-8f31f535.js"></script></body></html>